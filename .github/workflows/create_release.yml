name: Create Release from Artifacts

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name'
        required: true
        type: string
      release_name:
        description: 'Release name (defaults to tag name)'
        required: false
        type: string
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: true
        type: boolean
      workflow_run_id:
        description: 'Workflow run ID to download artifacts from (optional)'
        required: false
        type: string

permissions:
  contents: write
  actions: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts from workflow run
        if: ${{ inputs.workflow_run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.workflow_run_id }}
          pattern: '*-extension'
          merge-multiple: false

      - name: Create release ZIPs from artifacts (extension code per platform)
        run: |
          echo "Downloaded artifacts (extension folders):"
          ls -la
          mkdir -p release-assets
          # Only zip artifact dirs (chrome-extension, firefox-extension) - skip publish-extension submodule
          for dir in chrome-extension firefox-extension; do
            if [ -d "$dir" ] && [ -f "$dir/manifest.json" ]; then
              echo "Zipping $dir..."
              (cd "$dir" && zip -r ../release-assets/"$dir".zip .)
            fi
          done
          echo "Release ZIPs (extension code inside):"
          ls -la release-assets/
          if [ -z "$(ls -A release-assets 2>/dev/null)" ]; then
            echo "::error::No release packages found. Provide workflow_run_id from a Build Extension run."
            exit 1
          fi

      - name: Assemble release text
        run: |
          TAGNAME="${{ inputs.tag_name }}"
          sed -e "s/%tag%/$TAGNAME/g" .github/workflows/RELEASE_BODY.md > release_body0.txt 2>/dev/null || echo "Release $TAGNAME" > release_body0.txt
          if [ -f CHANGELOG.md ]; then
            grep -m1 -B10000 -- "----------" CHANGELOG.md | head -n -2 > release_notes.txt 2>/dev/null || echo "" > release_notes.txt
            sed -e '/%changelog%/{r release_notes.txt' -e 'd}' release_body0.txt > release_body.txt
          else
            cp release_body0.txt release_body.txt
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.tag_name }}
          name: ${{ inputs.release_name || inputs.tag_name }}
          prerelease: ${{ inputs.prerelease }}
          body_path: release_body.txt
          files: release-assets/*.zip
